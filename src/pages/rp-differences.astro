---
import BasicPage from '../layouts/BasicPage.astro';
import { getCollection } from 'astro:content';

const lessons = await getCollection('classroom');
const diffs = lessons
  .flatMap((lesson) =>
    lesson.data.rp_diffs.map((diff: any) => ({
      ...diff,
      lesson: lesson.data.title,
      url: `/how-to-law/classroom/${lesson.data.module}/${lesson.data.slug}/#${diff.id}`,
      module: lesson.data.moduleLabel ?? lesson.data.module
    }))
  )
  .sort((a, b) => a.id.localeCompare(b.id));
const grouped = diffs.reduce((acc: Record<string, typeof diffs>, diff) => {
  const key = diff.id;
  acc[key] = acc[key] ?? [];
  acc[key].push(diff);
  return acc;
}, {});
---
<BasicPage title="RP Differences" description="Track every place we bend US law for storytelling.">
  <p class="text-sm text-muted">Use these summaries to keep house rules consistent across sessions.</p>
  <div class="mt-8 space-y-8">
    {Object.entries(grouped).map(([id, items]) => (
      <section id={id} class="rounded-3xl border border-muted/30 bg-card/70 p-6 shadow-subtle">
        <h2 class="text-xl font-semibold text-foreground">{id.replace(/-/g, ' ')}</h2>
        <div class="mt-4 space-y-4 text-sm">
          {items.map((item) => (
            <article class="rounded-2xl border border-muted/30 bg-background/60 p-4">
              <p class="text-xs uppercase tracking-wide text-muted">{item.module}</p>
              <h3 class="text-base font-semibold text-foreground">{item.lesson}</h3>
              <div class="mt-2 grid gap-4 lg:grid-cols-2">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-wide text-muted">Baseline US law</p>
                  <p class="mt-1 text-sm text-foreground/80">{item.baseline}</p>
                </div>
                <div>
                  <p class="text-xs font-semibold uppercase tracking-wide text-muted">RP rule</p>
                  <p class="mt-1 text-sm text-foreground/80">{item.rule}</p>
                </div>
              </div>
              <a href={item.url} class="mt-3 inline-block text-xs font-semibold text-accent hover:underline">
                View in lesson â†’
              </a>
            </article>
          ))}
        </div>
      </section>
    ))}
  </div>
</BasicPage>
