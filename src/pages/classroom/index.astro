---
import BaseLayout from '~/layouts/BaseLayout.astro';
import { getLessonOrder, modules } from '~/lib/utils';
import { getCollection } from 'astro:content';

const lessons = await getCollection('classroom');
const modulesWithLessons = modules.map((module) => {
  const moduleLessons = lessons
    .filter((lesson) => {
      const lessonModule = lesson.data.module ?? lesson.slug.split('/')[0];
      return lessonModule === module.id;
    })
    .sort((a, b) => getLessonOrder(a) - getLessonOrder(b));
  return {
    ...module,
    lessons: moduleLessons.map((lesson) => ({
      title: lesson.data.title,
      description: lesson.data.description ?? lesson.data.summary ?? 'Lesson overview coming soon.',
      url: `/how-to-law/classroom/${module.id}/${lesson.slug.split('/')[1]}/`
    }))
  };
});
---
<BaseLayout
  title="Classroom"
  description="Structured modules covering United States legal doctrine, procedure, and Supreme Court practice."
>
  <section class="bg-background">
    <div class="mx-auto max-w-6xl px-4 py-16 sm:px-6 lg:px-8">
      <header class="max-w-3xl space-y-4">
        <p class="text-sm font-semibold uppercase tracking-wide text-accent">Curriculum</p>
        <h1 class="text-3xl font-semibold tracking-tight text-foreground sm:text-4xl">Classroom</h1>
        <p class="text-lg text-foreground/75">
          Work through the modules in order or focus on a particular subject. Lessons emphasise rules, practical implications, and
          appellate strategy. Each link below opens a detailed lesson with objectives, glossary popovers, and a knowledge check.
        </p>
      </header>
      <div class="mt-12 space-y-12">
        {modulesWithLessons.map((module) => (
          <section class="space-y-6">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-2xl font-semibold text-foreground">{module.title}</h2>
                <p class="text-sm text-foreground/70">{module.description}</p>
              </div>
              <span class="rounded-full bg-accent/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-accent">
                {module.lessons.length} lesson{module.lessons.length === 1 ? '' : 's'}
              </span>
            </div>
            <ul class="grid gap-4 md:grid-cols-2">
              {module.lessons.map((lesson) => (
                <li>
                  <a
                    href={lesson.url}
                    class="flex h-full flex-col justify-between rounded-2xl border border-border bg-card p-5 shadow-subtle transition hover:-translate-y-0.5 hover:border-accent/60 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
                  >
                    <div class="space-y-2">
                      <h3 class="text-lg font-semibold text-foreground">{lesson.title}</h3>
                      <p class="text-sm text-foreground/75">{lesson.description}</p>
                    </div>
                    <span class="mt-6 text-sm font-semibold text-accent">Open lesson â†’</span>
                  </a>
                </li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
